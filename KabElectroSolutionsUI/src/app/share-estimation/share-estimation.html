<form [formGroup]="shareForm">
  <div *ngIf="isLoading" class="loader-overlay">
        <div class="spinner-border text-primary" role="status">
        </div>
        <p class="text-white mt-2">Please wait...</p>
      </div>
<div class="dialog-container">

  <h2 class="dialog-header"><span>Share Estimation</span>  
    <button mat-icon-button (click)="onClose()">
      <mat-icon>close</mat-icon>
    </button>
  </h2>
  

  <!-- Table Headers -->
  <div class="table-header">
    <div>Type</div>
    <div>Material</div>
    <div>HSN Code</div>
    <div>Price</div>
    <div>Tax (%)</div>
    <div>Tax amount</div>
    <div>Total cost</div>
    <div></div>
  </div>

  <!-- Dynamic Items -->
  <div formArrayName="items" class="items-wrapper">
    <div *ngFor="let item of items.controls; let i = index" 
         [formGroupName]="i" 
         class="row">

      <!-- Type -->
      <mat-form-field appearance="outline">
        <mat-select formControlName="type">
          <mat-option value="Select">Select</mat-option>
          <mat-option value="Services">Services</mat-option>
          <mat-option value="Spare Parts">Spare Parts</mat-option>
        </mat-select>
      </mat-form-field>

      <!-- Material -->
      <mat-form-field appearance="outline">
        <mat-select formControlName="material">
          <mat-option *ngFor="let m of materialList" [value]="m">{{ m }}</mat-option>
        </mat-select>
      </mat-form-field>

      <!-- HSN -->
      <mat-form-field appearance="outline">
        <input matInput type="number" placeholder="HSN" formControlName="hsn" />
      </mat-form-field>

      <!-- Price -->
      <mat-form-field appearance="outline">
        <input matInput type="number" placeholder="Price" formControlName="price" />
      </mat-form-field>

      <!-- Tax -->
      <mat-form-field appearance="outline">
        <mat-select formControlName="tax">
          <mat-option value="0">0%</mat-option>
          <mat-option value="5">5%</mat-option>          
          <mat-option value="12">12%</mat-option>
          <mat-option value="18">18%</mat-option>
          <mat-option value="28">28%</mat-option>
        </mat-select>
      </mat-form-field>

      <!-- Calculated Tax Amount -->
      <div class="amount">{{ getTaxAmount(i) }}</div>

      <!-- Calculated Total -->
      <div class="amount">{{ getTotal(i) }}</div>

      <div class="actions">
        <!-- Remove Button -->
        <button mat-icon-button color="warn"
                (click)="removeRow(i)"
                [disabled]="!item.get('removable')?.value">
          <mat-icon>remove_circle</mat-icon>
        </button>

        <!-- Add Button -->
        <button *ngIf="i === items.length - 1"
                mat-icon-button color="primary"
                (click)="addRow()" 
                [disabled]="!isLastRowValid()">
          <mat-icon>add_circle</mat-icon>
        </button>
      </div>
    </div>
  </div>

  <!-- Total -->
  <div class="total-section">
    Total : <strong>{{ getGrandTotal() }}</strong>
  </div>

  <!-- Form Sections -->
  <div class="form-section">

    <!-- Observation -->
    <label>Observation: <span class="required">*</span></label>
    <textarea matInput maxlength="200" formControlName="observation"></textarea>

    <!-- Claim Type -->
    <label>Claim Type: <span class="required">*</span></label>
    <mat-radio-group class="radio-group" formControlName="claimType">
      <mat-radio-button value="Repair">Repair</mat-radio-button>
      <mat-radio-button value="Replace">Replace</mat-radio-button>
      <mat-radio-button value="Repair and Replace">Repair and Replace</mat-radio-button>
    </mat-radio-group>

    <!-- Symptom -->
    <label>Symptom: <span class="required">*</span></label>
    <textarea matInput maxlength="200" formControlName="symptom"></textarea>

    <!-- Remarks -->
    <mat-form-field appearance="outline" class="remarks-field">
      <input matInput placeholder="Any remarks ?" formControlName="remarks" />
    </mat-form-field>
  </div>
</div>

<!-- IMAGE UPLOAD SECTION -->
<div class="image-grid" formArrayName="imagesArray">
  
  <div class="image-card mat-elevation-z2"
       *ngFor="let img of imagesArray.controls; let i = index"
       [formGroupName]="i">

    <!-- Title -->
    <div class="image-title">
      {{ img.value.label }}
      <span *ngIf="img.value.required" class="required">*</span>
    </div>

    <!-- Upload Box -->
    <div class="upload-box" (click)="triggerFile(i)">
      
      <!-- Preview -->
      <img *ngIf="img.value.previewUrl"
           [src]="img.value.previewUrl"
           class="preview-image">

      <!-- Placeholder -->
      <div class="placeholder" *ngIf="!img.value.previewUrl">
        <mat-icon>cloud_upload</mat-icon>
        <span>{{ img.value.fileName || 'Choose File' }}</span>
      </div>
    </div>

    <!-- Hidden Input -->
 <input #fileInputs
       type="file"
       hidden
       accept="image/*"
       (change)="onSelectImage($event, i)">
  </div>
</div>


<!-- ACTION BUTTON ROW -->
<div class="action-row">
  <button class="add-btn" (click)="addImage('Upload image')">
    + ADD IMAGE
  </button>

  <button class="add-btn"
          (click)="shareEstimate()"
          [disabled]="imagesArray.length === 0 && shareForm.invalid || isSubmitting">
    SHARE ESTIMATE
  </button>
</div>

</form>
